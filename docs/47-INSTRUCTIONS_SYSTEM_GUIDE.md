# Document 47: Instructions System Guide

**Created:** 2025-11-05
**Status:** Active Reference
**Purpose:** Guide for understanding and using the frontend instructions modal system

---

## Table of Contents

1. [Overview](#overview)
2. [Architecture](#architecture)
3. [How It Works](#how-it-works)
4. [Adding Instructions](#adding-instructions)
5. [Using Instructions in Pages](#using-instructions-in-pages)
6. [File Locations](#file-locations)
7. [Troubleshooting](#troubleshooting)

---

## Overview

The instructions system provides a consistent help/tutorial modal across the application. When users click the floating help button (FAB), a modal displays page-specific instructions.

**Key Features:**
- Centralized instructions storage
- Context-based state management
- Automatic page detection
- Reusable UI components
- Generated code infrastructure

---

## Architecture

### Component Hierarchy

```
App (InstructionsProvider)
  └── AppLayout
      ├── InstructionsFAB (Floating Help Button)
      └── InstructionsModal (Modal Display)

Page Component
  └── usePageInstructions('page-id') hook
```

### State Flow

```
1. Page mounts
   ↓
2. usePageInstructions('page-id') runs
   ↓
3. Fetches from InstructionsService.getInstructions('page-id')
   ↓
4. If found → setInstructions(title, instructions[])
   ↓
5. Updates InstructionsContext (global state)
   ↓
6. User clicks FAB button
   ↓
7. openInstructions() called
   ↓
8. Modal reads from context and displays
```

---

## How It Works

### 1. Context Provider (Global State)

**File:** `/frontend/src/contexts/InstructionsContext.tsx`

**Purpose:** Provides global state for instructions across the app

**State:**
- `instructions: string[]` - Array of instruction strings
- `title: string` - Modal title
- `showInstructions: boolean` - Modal visibility

**Methods:**
- `setInstructions(pageId, data)` - Update instructions for current page
- `openInstructions()` - Show modal
- `closeInstructions()` - Hide modal

**Usage:**
```typescript
// App.tsx
<InstructionsProvider>
  <AppContent />
</InstructionsProvider>
```

### 2. Service (Data Source)

**File:** `/frontend/src/services/instructions/InstructionsService.ts`

⚠️ **WARNING: GENERATED CODE** - See [Adding Instructions](#adding-instructions) for proper modification

**Purpose:** Centralized storage of all page instructions

**Structure:**
```typescript
private instructionsMap: Map<string, PageInstructions> = new Map()

interface PageInstructions {
  readonly title: string
  readonly instructions: readonly string[]
}
```

**Methods:**
- `getInstructions(pageId)` - Fetch instructions for a page
- `hasInstructions(pageId)` - Check if instructions exist
- `updateInstructions(pageId, instructions)` - Dynamically add/update
- `getSubPages(parentPageId)` - Get hierarchical sub-pages

**Page ID Format:**
- Top-level: `'dashboard'`, `'settings'`
- Hierarchical: `'dashboard.credentials'`, `'settings.providers'`

### 3. Hook (Bridge)

**File:** `/frontend/src/hooks/core/usePageInstructions.ts`

**Purpose:** Automatically loads instructions when page mounts

**Usage:**
```typescript
import { usePageInstructions } from '@/hooks/core/usePageInstructions';

export function MyPage() {
  usePageInstructions('my-page-id');

  return <div>Page content...</div>;
}
```

**What it does:**
```typescript
export const usePageInstructions = (pageId: string) => {
  const { setInstructions } = useInstructions()

  useEffect(() => {
    const pageInstructions = instructionsService.getInstructions(pageId)

    if (pageInstructions) {
      setInstructions(pageInstructions.title, [...pageInstructions.instructions])
    }
  }, [pageId, setInstructions])
}
```

### 4. UI Components

#### InstructionsFAB (Floating Action Button)

**File:** `/frontend/src/components/core/InstructionsFAB.tsx`

**Location:** Bottom-right corner of screen

**Appearance:** Blue circular button with `HelpCircle` icon

**Trigger:** Clicking calls `openInstructions()` from context

#### InstructionsModal (Modal Display)

**File:** `/frontend/src/components/core/InstructionsModal.tsx`

**Props:**
- `isOpen: boolean` - Visibility state
- `onClose: () => void` - Close handler
- `title: string` - Modal header
- `instructions: string[]` - Instruction list

**Display:**
- Backdrop overlay (dismissible)
- Centered modal with rounded corners
- Target icon + title
- Bulleted instruction list
- "Got it!" dismiss button

---

## Adding Instructions

### Option 1: Modify Generated Code (Not Recommended)

⚠️ **WARNING:** Changes will be overwritten by generator

The file `/frontend/src/services/instructions/InstructionsService.ts` is generated by:
```
/tools/frontend-tools/mobile-pages-mini/modules/dependency_manager.py
```

To make permanent changes, modify the Python generator and re-run it.

### Option 2: Create Custom Service (Recommended for Non-Generated Apps)

Create a separate service for your app's instructions:

**Step 1:** Create custom service

```typescript
// /frontend/src/services/dashboard-instructions.ts
export interface PageInstructions {
  readonly title: string
  readonly instructions: readonly string[]
}

class DashboardInstructionsService {
  private static instance: DashboardInstructionsService | null = null
  private instructionsMap: Map<string, PageInstructions> = new Map()

  private constructor() {
    this.initializeInstructions()
  }

  public static getInstance(): DashboardInstructionsService {
    if (!DashboardInstructionsService.instance) {
      DashboardInstructionsService.instance = new DashboardInstructionsService()
    }
    return DashboardInstructionsService.instance
  }

  private initializeInstructions(): void {
    // Add dashboard instructions
    this.instructionsMap.set('dashboard', {
      title: 'Dashboard Overview',
      instructions: [
        'Login to Qwen to enable AI features',
        'Start the proxy server to route API requests',
        'Configure providers in the Providers tab',
        'Monitor activity in the Activity tab'
      ]
    })

    this.instructionsMap.set('dashboard.credentials', {
      title: 'Qwen Authentication',
      instructions: [
        'Click "Login to Qwen" to authenticate',
        'Browser extension will extract credentials automatically',
        'Credentials are stored securely in the API server',
        'Refresh credentials if they expire'
      ]
    })

    // Add more pages...
  }

  public getInstructions(pageId: string): PageInstructions | null {
    return this.instructionsMap.get(pageId) || null
  }

  public hasInstructions(pageId: string): boolean {
    return this.instructionsMap.has(pageId)
  }
}

export const dashboardInstructionsService = DashboardInstructionsService.getInstance()
```

**Step 2:** Create custom hook

```typescript
// /frontend/src/hooks/useDashboardInstructions.ts
import { useEffect } from 'react'
import { useInstructions } from '@/contexts/InstructionsContext'
import { dashboardInstructionsService } from '@/services/dashboard-instructions'

export const useDashboardInstructions = (pageId: string) => {
  const { setInstructions } = useInstructions()

  useEffect(() => {
    const pageInstructions = dashboardInstructionsService.getInstructions(pageId)

    if (pageInstructions) {
      setInstructions(pageInstructions.title, [...pageInstructions.instructions])
    }
  }, [pageId, setInstructions])
}
```

### Option 3: Runtime Updates (Dynamic Instructions)

For instructions that change based on state:

```typescript
import { useInstructions } from '@/contexts/InstructionsContext'

export function DynamicPage() {
  const { setInstructions } = useInstructions()

  useEffect(() => {
    // Set instructions dynamically
    setInstructions('Dynamic Page', [
      'Step 1: Do something dynamic',
      'Step 2: Based on current state',
      `Step 3: User is ${user.name}`
    ])
  }, [user, setInstructions])

  return <div>Content</div>
}
```

---

## Using Instructions in Pages

### Basic Usage

```typescript
import { usePageInstructions } from '@/hooks/core/usePageInstructions'

export function MyPage() {
  // Automatically loads instructions for 'my-page'
  usePageInstructions('my-page')

  return (
    <div>
      {/* Page content */}
      {/* FAB will automatically appear in AppLayout */}
    </div>
  )
}
```

### Hierarchical Pages

For sub-pages or nested routes:

```typescript
// Parent page
export function SettingsPage() {
  usePageInstructions('settings')
  return <div>Settings</div>
}

// Child page
export function SettingsProvidersPage() {
  usePageInstructions('settings.providers') // Dot notation for hierarchy
  return <div>Provider Settings</div>
}
```

### Conditional Instructions

Only show instructions under certain conditions:

```typescript
export function ConditionalPage() {
  const [showHelp, setShowHelp] = useState(true)

  // Only load instructions if help is needed
  if (showHelp) {
    usePageInstructions('conditional-page')
  }

  return <div>Content</div>
}
```

### Manual Control

If you need full control:

```typescript
import { useInstructions } from '@/contexts/InstructionsContext'

export function ManualPage() {
  const { setInstructions, openInstructions, closeInstructions } = useInstructions()

  const showCustomHelp = () => {
    setInstructions('Custom Help', [
      'Custom instruction 1',
      'Custom instruction 2'
    ])
    openInstructions()
  }

  return (
    <div>
      <button onClick={showCustomHelp}>Show Help</button>
    </div>
  )
}
```

---

## File Locations

### Core Files

| File | Purpose | Generated? |
|------|---------|------------|
| `/frontend/src/contexts/InstructionsContext.tsx` | Global state provider | ✅ Yes |
| `/frontend/src/services/instructions/InstructionsService.ts` | Instructions data store | ✅ Yes |
| `/frontend/src/hooks/core/usePageInstructions.ts` | Auto-load hook | ✅ Yes |
| `/frontend/src/components/core/InstructionsFAB.tsx` | Floating help button | ✅ Yes |
| `/frontend/src/components/core/InstructionsModal.tsx` | Modal display | ✅ Yes |

### Integration Points

| File | Integration |
|------|-------------|
| `/frontend/src/App.tsx` | Wraps app with `<InstructionsProvider>` |
| `/frontend/src/components/layout/AppLayout.tsx` | Renders `<InstructionsFAB>` and `<InstructionsModal>` |

### Custom Extensions (Not Generated)

Create these files to extend the system without modifying generated code:

```
/frontend/src/services/
  └── dashboard-instructions.ts          ← Custom instructions service

/frontend/src/hooks/
  └── useDashboardInstructions.ts        ← Custom hook for dashboard
```

---

## Troubleshooting

### Problem: Modal Shows But No Instructions

**Symptoms:**
- FAB button works
- Modal opens
- Modal is empty or shows placeholder

**Cause:** Page didn't call `usePageInstructions()` or page ID not found in service

**Solution:**
```typescript
// Add to page component
import { usePageInstructions } from '@/hooks/core/usePageInstructions'

export function MyPage() {
  usePageInstructions('my-page-id')  // ← Add this
  return <div>Content</div>
}
```

**Verify page ID exists:**
```typescript
import { instructionsService } from '@/services/instructions/InstructionsService'

// Check if instructions exist
console.log(instructionsService.hasInstructions('my-page-id'))

// Get instructions
console.log(instructionsService.getInstructions('my-page-id'))
```

### Problem: Instructions Not Updating

**Symptoms:** Old instructions show after navigating to new page

**Cause:** Previous page's instructions still in context

**Solution:** Always call `usePageInstructions()` in every page component

### Problem: FAB Button Not Visible

**Symptoms:** Help button doesn't appear

**Cause:** Not using `AppLayout` or FAB is hidden by CSS

**Check:**
1. Is page wrapped in `<AppLayout>`?
2. Is FAB being covered by z-index issues?
3. Browser console errors?

### Problem: Cannot Modify InstructionsService.ts

**Symptoms:** Changes keep getting reverted

**Cause:** File is generated code

**Solution:** Use Option 2 or Option 3 from [Adding Instructions](#adding-instructions)

---

## Best Practices

### 1. Use Descriptive Page IDs

```typescript
// ✅ Good
usePageInstructions('dashboard.credentials.login')

// ❌ Bad
usePageInstructions('page1')
```

### 2. Keep Instructions Concise

```typescript
// ✅ Good - actionable steps
instructions: [
  'Click "Login" to authenticate',
  'Enter your credentials',
  'Wait for confirmation'
]

// ❌ Bad - too verbose
instructions: [
  'In order to proceed with authentication, please locate the login button...'
]
```

### 3. Use Hierarchy for Related Pages

```typescript
'settings'                    // Parent
'settings.providers'          // Child
'settings.providers.add'      // Grandchild
```

### 4. Don't Modify Generated Files

If files have `⚠️ WARNING: GENERATED CODE` headers, create custom services instead.

### 5. Test Instructions in Development

```typescript
// Quick test in browser console
window.instructionsService = require('@/services/instructions/InstructionsService').instructionsService
window.instructionsService.getInstructions('dashboard')
```

---

## Examples

### Example 1: Dashboard Main Page

```typescript
// /frontend/src/pages/dashboard/DashboardMainPage.tsx
import { usePageInstructions } from '@/hooks/core/usePageInstructions'

export function DashboardMainPage() {
  usePageInstructions('dashboard')

  return (
    <div className="dashboard-container">
      <QwenLoginCard />
      <ProxyControlCard />
      <StatisticsCard />
    </div>
  )
}
```

**Instructions in service:**
```typescript
this.instructionsMap.set('dashboard', {
  title: 'Dashboard Overview',
  instructions: [
    'Login to Qwen to enable AI features',
    'Start the proxy server to route requests',
    'Monitor statistics and activity',
    'Use the action menu for advanced options'
  ]
})
```

### Example 2: Providers Page with Sub-Pages

```typescript
// Parent page
export function ProvidersPage() {
  usePageInstructions('providers')
  return <ProvidersList />
}

// Add provider sub-page
export function AddProviderPage() {
  usePageInstructions('providers.add')
  return <AddProviderForm />
}

// Edit provider sub-page
export function EditProviderPage() {
  usePageInstructions('providers.edit')
  return <EditProviderForm />
}
```

### Example 3: Dynamic Instructions Based on State

```typescript
export function CredentialsPage() {
  const { status } = useCredentials()
  const { setInstructions } = useInstructions()

  useEffect(() => {
    if (status.hasCredentials) {
      setInstructions('Manage Credentials', [
        'Your credentials are active',
        'Click refresh to update them',
        'Click delete to remove them'
      ])
    } else {
      setInstructions('Add Credentials', [
        'Click "Login to Qwen" to get started',
        'Browser extension will extract credentials',
        'Credentials will be saved automatically'
      ])
    }
  }, [status.hasCredentials, setInstructions])

  return <div>Content</div>
}
```

---

## Summary

**The instructions system provides:**
- ✅ Centralized instructions management
- ✅ Consistent UI/UX across pages
- ✅ Easy integration with one hook call
- ✅ Support for hierarchical pages
- ✅ Dynamic runtime updates
- ✅ Extensible architecture

**To add instructions to a page:**
1. Add instructions to service map (or create custom service)
2. Call `usePageInstructions('page-id')` in page component
3. FAB and modal work automatically

**Remember:**
- Generated files should not be modified directly
- Use custom services for non-generated apps
- Always test instructions in development
- Keep instructions concise and actionable

---

**Document Version:** 1.0
**Last Updated:** 2025-11-05
**Next Review:** When adding new major features
